version: '3'

vars:
  PORT_ORG: 15432
  PORT_PROFILE: 15433
  PORT_LICENSE: 15434
  SCHEMA_ORG: org.hcl
  SCHEMA_PROFILE: profile.hcl
  SCHEMA_LICENSE: license.hcl

tasks:
  all:
    desc: "Starts everything"
    deps:
      - task: worker
      - task: starter
      - task: service-license
      - task: service-org
      - task: service-profile

  infra:
    run: once
    desc: "Runs Docker Compose infra"
    cmds:
      - pkgx docker-clean stop
      - docker compose up -d
      - task: migrate

  worker:
    run: once
    deps:
      - task: infra
    desc: "Runs Temporal worker"
    cmd: go run cmd/saga/worker/main.go

  starter:
    run: once
    deps:
      - task: infra
    desc: "Runs Temporal workflow starter service"
    cmds:
      - pkgx killport 8081
      - go run cmd/saga/start/main.go
    env:
      GRPC_CONNECT_PORT: 8081

  service-license:
    run: once
    deps:
      - task: infra
    desc: "Runs license service"
    cmds:
      - pkgx killport 9090
      - go run cmd/svc/license/main.go
    env:
      GRPC_CONNECT_PORT: 9090

  service-org:
    run: once
    deps:
      - task: infra
    desc: "Runs Org service"
    cmds:
      - pkgx killport 9091
      - go run cmd/svc/org/main.go
    env:
      GRPC_CONNECT_PORT: 9091

  service-profile:
    run: once
    deps:
      - task: infra
    desc: "Runs profile service"
    cmds:
      - pkgx killport 9092
      - go run cmd/svc/profile/main.go
    env:
      GRPC_CONNECT_PORT: 9092

  inspect:
    desc: "Inspect"
    cmds:
      - task: int-inspect
        vars:
          PORT: "{{ .PORT_ORG }}"
      - task: int-inspect
        vars:
          PORT: "{{ .PORT_PROFILE }}"
      - task: int-inspect
        vars:
          PORT: "{{ .PORT_LICENSE }}"

  int-inspect:
    internal: true
    cmd: |
      pkgx +atlasgo.io atlas \
        schema inspect \
        -u "postgres://postgres:postgrespassword@localhost:{{ .PORT }}/postgres?sslmode=disable" \
        --schema public

  migrate:
    desc: "Applies database migrations"
    cmds:
      - task: int-migrate
        vars:
          PORT: "{{ .PORT_ORG }}"
          SCHEMA_FILE: "{{ .SCHEMA_ORG }}"
      - task: int-migrate
        vars:
          PORT: "{{ .PORT_PROFILE }}"
          SCHEMA_FILE: "{{ .SCHEMA_PROFILE }}"
      - task: int-migrate
        vars:
          PORT: "{{ .PORT_LICENSE }}"
          SCHEMA_FILE: "{{ .SCHEMA_LICENSE }}"

  int-migrate:
    internal: true
    env:
      PGHOST: localhost
      PGPORT: "{{ .PORT }}"
      PGUSER: postgres
      PGPASSWORD: postgrespassword
      PGDATABASE: postgres
    cmds:
      # Wait for Postgres to start. Yes, we need this...
      - "pkgx eb -x 20 -- lsof -i :{{ .PORT }}"
      # Wait for Postgres to get ready. Yes, we need this as well...
      - |
        pkgx eb -x 20 -- pkgx pg_isready && [[ "$?" -eq 0 ]]
      - |
        pkgx +atlasgo.io atlas \
          schema apply \
          -u "postgres://postgres:postgrespassword@localhost:{{ .PORT }}/postgres?sslmode=disable" \
          --to file://db/schema/{{ .SCHEMA_FILE }} \
          --schema public \
          --auto-approve